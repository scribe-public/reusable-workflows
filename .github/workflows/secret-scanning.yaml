name: SSDF Evaluation

on:
  workflow_call:
    # inputs:
    #   scribe_product_name:
    #     description: "Scribe Product Name"
    #     required: true
    #     type: string
    #   scribe_product_version:
    #     description: "Scribe Product Version"
    #     required: true
    #     type: string

jobs:
    secret-scanning:
        runs-on: ubuntu-latest
        steps:
            - name: install trivy
              run: |
                wget https://github.com/aquasecurity/trivy/releases/download/v0.18.3/trivy_0.18.3_Linux-64bit.deb
                sudo dpkg -i trivy_0.18.3_Linux-64bit.deb
                trivy -h

            - name: Checkout
              uses: actions/checkout@v2

            - name: create report name
              run: |
                REPO_NAME=$(echo "${GITHUB_REPOSITORY}" | cut -d'/' -f2)
                echo "FILENAME=${REPO_NAME}-secret-scan.sarif" >> $GITHUB_ENV
                echo ${{ env.FILENAME }}

            - name: Run Trivy
              run: |
                trivy fs . --scanners secret --severity CRITICAL,HIGH --format sarif -o ${{ env.FILENAME }}

            - name: upload evidence
              uses: actions/upload-artifact@v4
              with:
                path: ${{ env.FILENAME }}
                
            - name: install valint
              uses: scribe-security/action-installer@dev

            - name: create evidence
              run: | 
                valint evidence  ${{ env.FILENAME}} --label ${{env.FILENAME}}    

            # - name: evaluate policy
            #   run: |
            #     valint verify --rule-args att_name="${{github.repository}}-secret.sarif" --policy $(pwd)/policies/sheet.yaml

            
